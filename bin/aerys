#!/usr/bin/env php

<?php

if (!extension_loaded("uv") && extension_loaded("pcntl")) {
    declare(ticks=1);
}

if (PHP_MAJOR_VERSION < 7) {
    echo "Aerys requires PHP >= 7.0.0\n\n";
    exit(1);
}

error_reporting(E_ALL);
ini_set("display_errors", "stderr");

require __DIR__ . "/../autoload.php";

$help = <<<EOT
      ____ _ ___   _____ __  __ _____
     / __ `// _ \ / ___// / / // ___/
    / /_/ //  __// /   / /_/ //__  /
    \__,_/ \___//_/    \__, //____/
                      /____/

    -h, --help        Display help screen
    -d, --debug       Start the server in debug mode
    -c, --config      Use the specified config file to bootstrap the server
    -w, --workers     Manually specify worker count (default: CPU core count)
    -r, --remote      @TODO A port number on which to listen for stop/reload commands

    Example Usage:

    aerys --help
    aerys -c /path/to/app/config.php
    aerys --config /path/to/app/config.php --workers 4
    aerys -c /my/config.php -r 23456


EOT;

$cliArgs = Aerys\Bootstrapper::parseCommandLineArgs();
if ($cliArgs["help"]) {
    echo $help;
    exit(0);
}

try {
    Amp\run(function($reactor) use ($cliArgs) {
        if ($cliArgs["debug"]) {
            $watcher = new Aerys\DebugWatcher($reactor);
        } elseif (stripos(PHP_OS, "WIN") === 0) {
            die("Debug mode flag -d required (worker watchers not yet implemented)\n\n");
            // @TODO: $watcher = new Aerys\WorkerSocketWatcher($reactor);
        } else {
            die("Debug mode flag -d required (worker watchers not yet implemented)\n\n");
            // @TODO: $watcher = new Aerys\WorkerProcessWatcher($reactor);
        }
        yield from $watcher->watch($cliArgs);
    });
} catch (BaseException $e) {
    echo "\n", (empty($cliArgs["debug"]) ? $e->getMessage() : $e), "\n\n";
    exit(1);
}
