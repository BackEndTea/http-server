#!/usr/bin/env php
<?php

error_reporting(E_ALL);
ini_set('display_errors', 1);

require __DIR__ . '/../src/bootstrap.php';

$help = <<<EOT

    Aerys HTTP Server
    -----------------

    -h, --help        Display help screen
    -d, --debug       Start the server in debug mode
    -c, --config      Use the specified config file to bootstrap the server
    -w, --workers     Manually specify worker count (default: CPU core count)
    -z, --control     A port number on which to listen for stop/reload commands

    Example Usage:

    aerys --help
    aerys -c /path/to/app/config.php
    aerys --config /path/to/app/config.php --workers 4
    aerys -c /my/config.php -z tcp://127.0.0.1:23456


EOT;

try {

    $options = (new Aerys\BinOptions)->loadOptions();

    if ($options->getHelp()) {
        echo $help;
        exit(0);
    } elseif ($options->getDebug()) {
        $watcher = new Aerys\DebugWatcher;
    } elseif (extension_loaded('pthreads')) {
        $watcher = new Aerys\ThreadWatcher;
    } elseif (extension_loaded('pcntl')) {
        $watcher = new Aerys\ForkWatcher;
    } else {
        $watcher = new Aerys\ProcWatcher;
    }

    $watcher->watch($options);

} catch (Exception $e) {
    printf("\n%s\n\n", $e->getMessage());
    exit(1);
}
