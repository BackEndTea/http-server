#!/usr/bin/env php
<?php

error_reporting(E_ALL);
ini_set('display_errors', 1);

require __DIR__ . '/../src/bootstrap.php';

$help = <<<EOT

    Aerys HTTP Server
    -----------------

    -h, --help        Display help screen
    -c, --config      Use the specified config file to bootstrap the server
    -w, --workers     Manually specify worker count (default: CPU core count)
    -z, --control     Specify a port number for server control commands
    -b, --backend     Specify a custom port number for backend IPC communication

    Run a static file server without a config file:

    -r, --root        Required filesystem directory from which to serve static files
    -p, --port        Optional port on which to listen (default: 80)
    -i, --ip          Optional IP on which to bind (default: all IPv4 interfaces)
    -n, --name        Optional host/domain name

    Example Usage:

    aerys --help
    aerys -c /path/to/app/config.php
    aerys --config /path/to/app/config.php --workers 4
    aerys --root /path/to/document/root --name mysite.com
    aerys -r /path/to/document/root -p 1337
    aerys -r /path/to/document/root --ip="[::]"
    aerys -c /my/config.php -z tcp://127.0.0.1:23456


EOT;

try {

    $options = (new Aerys\Start\BinOptions)->loadOptions();

    if ($options->getHelp()) {
        echo $help;
        exit(0);
    } elseif (extension_loaded('pthreads')) {
        $watcher = new Aerys\Watch\ThreadWatcher;
    } elseif (extension_loaded('pcntl')) {
        $watcher = new Aerys\Watch\ForkWatcher;
    } else {
        $watcher = new Aerys\Watch\ProcessWatcher;
    }

    $watcher->watch($options);

} catch (Exception $e) {
    printf("\n%s\n\n", $e->getMessage());
    exit(1);
}
