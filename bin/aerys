#!/usr/bin/env php
<?php

$help = <<<EOT
      ____ _ ___   _____ __  __ _____
     / __ `// _ \ / ___// / / // ___/
    / /_/ //  __// /   / /_/ //__  /
    \__,_/ \___//_/    \__, //____/
                      /____/

    -c, --config      Define a custom server config path
    -d, --debug       Start the server in debug mode
    -h, --help        Display the help screen
    -l, --log         Set the minimum log output level (default: info)
    -r, --remote      @TODO A local port on which to listen for commands
    -w, --workers     Manually specify worker count (default: CPU core count)
        --color       Use ANSI codes in output (auto|on|off default: auto)

    Example Usage:
    aerys --help
    aerys --color off --log info
    aerys --config /path/to/app/config.php --w 4
    aerys --remote 23456 --log warning


EOT;

if (PHP_MAJOR_VERSION < 7) {
    echo "Aerys requires PHP >= 7.0.0\n\n";
    exit(1);
}

@cli_set_process_title("aerys");
error_reporting(E_ALL);
require __DIR__ . "/../autoload.php";
$climate = new League\CLImate\CLImate;
$climate->arguments->add([
    "debug" => [
        "prefix"       => "d",
        "longPrefix"   => "debug",
        "description"  => "Start the server in debug mode",
        "noValue"      => true,
    ],
    "help" => [
        "prefix"       => "h",
        "longPrefix"   => "help",
        "description"  => "Display the help screen",
        "noValue"      => true,
    ],
    "log" => [
        "prefix"       => "l",
        "longPrefix"   => "log",
        "description"  => "Set the minimum log output level",
        "defaultValue" => "info",
    ],
    "remote" => [
        "prefix"       => "r",
        "longPrefix"   => "remote",
        "description"  => "A local port on which to listen for commands",
        "castTo"       => "int",
    ],
    "workers" => [
        "prefix"       => "w",
        "longPrefix"   => "workers",
        "description"  => "Manually specify worker count",
        "castTo"       => "int",
    ],
    "color" => [
        "longPrefix"   => "color",
        "description"  => "Use ANSI codes in output",
        "castTo"       => "string",
        "defaultValue" => "auto",
    ],
    "config" => [
        "prefix"       => "c",
        "longPrefix"   => "config",
        "description"  => "Define a custom server config path",
    ],
]);
$climate->arguments->parse();
if ($climate->arguments->defined("help")) {
    echo $help;
    exit(0);
}

Amp\run(function(Amp\Reactor $reactor) use ($climate) {
    try {
        $logger = new Aerys\ConsoleLogger($climate);
        if ($climate->arguments->defined("debug") || php_sapi_name() === "phpdbg") {
            $watcher = new Aerys\DebugWatcher($reactor, $logger);
        } else {
            die("\nDebug mode flag required (-d)\n\n");
        }
        yield Amp\resolve($watcher->watch($climate));
    } catch (\BaseException $uncaught) {
        $logger->critical($uncaught);
        exit(1);
    }
});
