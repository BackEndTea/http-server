#!/usr/bin/env php

<?php

if (extension_loaded('pcntl')) {
    declare(ticks=1);
}

error_reporting(E_ALL);
ini_set('display_errors', 'stderr');

require __DIR__ . '/../src/autoload.php';

$help = <<<EOT
      ____ _ ___   _____ __  __ _____
     / __ `// _ \ / ___// / / // ___/
    / /_/ //  __// /   / /_/ //__  /
    \__,_/ \___//_/    \__, //____/
                      /____/

    -h, --help        Display help screen
    -d, --debug       Start the server in debug mode
    -c, --config      Use the specified config file to bootstrap the server
    -w, --workers     Manually specify worker count (default: CPU core count)
    -r, --remote      @TODO A port number on which to listen for stop/reload commands

    Example Usage:

    aerys --help
    aerys -c /path/to/app/config.php
    aerys --config /path/to/app/config.php --workers 4
    aerys -c /my/config.php -r 23456


EOT;


$options = Aerys\parseCommandLineOptions();

if ($options['help']) {
    echo $help;
    exit(0);
}

try {
    Amp\run(function($reactor) use ($options) {
        $injector = new Auryn\Provider;
        $injector->alias('Amp\Reactor', get_class($reactor));
        $injector->share($reactor);
        $bootstrapper = new Aerys\Bootstrapper($injector);
        $watcher = $bootstrapper->boot($options);
        yield $watcher->watch();
    });
} catch (Exception $e) {
    echo "\n", $e->getMessage(), "\n\n";
    exit(1);
}
